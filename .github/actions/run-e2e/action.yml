name: "Run Script & Assert Output"
description: "Run a script via the Elixir Script Action, and verify its output matches the expected result"
inputs:
  image-name:
    description: "The container image the Elixir Script Action uses to run the script"
    required: true
  script:
    description: "The script to run"
    required: true
  expected:
    description: "The expected output"
runs:
  using: "composite"
  steps:
    - name: Update action.yml to point to ${{ inputs.image-name }}
      run: |
        sed -i 's/\(  image: \).*/\1${{ inputs.image-name }}/' action.yml
      shell: bash
    - name: Create script files
      if: ${{ matrix.file_content }}
      shell: bash
      run: |
        echo "Creating files for test: ${{ matrix.name }}"
        # Use jq to iterate over the JSON object
        echo '${{ toJSON(matrix.file_content) }}' | jq -r 'to_entries[] | @json' | while IFS= read -r entry; do
          path=$(echo "$entry" | jq -r '.key')
          content=$(echo "$entry" | jq -r '.value')
          
          # Create directory if needed
          dir=$(dirname "$path")
          mkdir -p "$dir"
          
          # Write the file content
          echo "$content" > "$path"
          echo "Created file: $path"
        done
    - name: Run gaggle/elixir_script
      id: run
      uses: ./
      with:
        script: ${{ matrix.script }}
    - name: Assert output
      if: ${{ !!matrix.expected }}
      run: |
        expected="${{ matrix.expected }}"
        output="${{steps.run.outputs.result}}"
        [[ "$output" != "$expected" ]] && echo "::error::❌ Expected '$expected', got '$output'" && exit 1
        echo "✅ Test passed, outputs.result: ${{toJSON(steps.run.outputs.result)}}"
      shell: bash

#!/usr/bin/env -S pkgx bash>=4
set -euo pipefail
# This script is used to perform an audit of the Elixir project.
# It checks for formatting issues, static code analysis, and code style consistency.
#
# Usage:
#   ./bin/audit                    # Run to audit your project.
#   ./bin/audit --skip-check-image # Skip Docker image check (used by CI)

SKIP_CHECK_IMAGE=false

# Parse arguments
for arg in "$@"; do
  case $arg in
    --skip-check-image)
      SKIP_CHECK_IMAGE=true
      shift
      ;;
    *)
      echo "Unknown option: $arg"
      exit 1
      ;;
  esac
done

echo "Checking code formatting..."
bin/format --check

echo "Running static code analysis with dialyzer..."
if [ "${CI:-}" == "true" ]; then
    mix dialyzer --format github
else
    mix dialyzer
fi

echo "Checking code style with Credo..."
mix credo --strict

echo "Checking examples workflow is up-to-date..."
mix e2e.update_examples_workflow --check

if [ "$SKIP_CHECK_IMAGE" = false ]; then
  echo "Checking Docker image..."
  bin/check-image
else
  echo "Skipping Docker image check..."
fi
